<?xml version="1.0" encoding="utf-8"?>
<common:CustomTitleWindow xmlns:mx="http://www.adobe.com/2006/mxml"
						  xmlns:common="view.common.*"
						  verticalScrollPolicy="off"
						  horizontalScrollPolicy="off"
						  autoLayout="true"
						  showCloseButton="true"
						  title="{resourceManager.getString('myResources', 'TITLE_LOGIN_FORM')}"
						  creationComplete="completeHandler()">
	<mx:Metadata>
		[ResourceBundle("myResources")]
	</mx:Metadata>

	<mx:Script>
		<![CDATA[
			import com.adobe.crypto.SHA1;
			
			import events.LoginEvent;
			
			import model.DataModel;
			
			import mx.events.CloseEvent;
			import mx.managers.PopUpManager;
			
			import vo.LoginVO;
			import vo.UserVO;

			//The keyCode for ENTER key
			public static const ENTER_KEY:int=13;

			private var rememberSO:SharedObject;

			public function completeHandler():void
			{
				this.addEventListener(CloseEvent.CLOSE, closeButtonClickHandler);
				this.addEventListener(KeyboardEvent.KEY_DOWN, checkPressedKey);
				focusManager.setFocus(username);
			}

			private function checkPressedKey(e:KeyboardEvent):void
			{
				if (e.keyCode == ENTER_KEY)
				{
					if(loginViewStack.selectedChild == loginFormBox)
						processLogin(null);
					else if(loginViewStack.selectedChild == restorePassFormBox)
						processRestorePass(null);
					else if(loginViewStack.selectedChild == resendActivationEmailBox)
						resendActivationEmail(null);
				}
			}

			private function processLogin(event:Event):void
			{
				//Encrypt password for security
				var passHash:String=SHA1.hash(password.text);
				var user:LoginVO=new LoginVO(username.text, passHash);
				new LoginEvent(LoginEvent.PROCESS_LOGIN, user).dispatch();
			}
			
			public function closeButtonClickHandler(event:CloseEvent):void{
				PopUpManager.removePopUp(this);
			}

			public function cancelButtonClickHandler(event:MouseEvent):void
			{
				PopUpManager.removePopUp(this);
			}

			private function set wrongLogin(upd:Boolean):void
			{
				if (DataModel.getInstance().loginErrorMessage != '')
				{
					if(DataModel.getInstance().loginErrorMessage == "inactive_user"){
						resendEmailLink.visible = true;
					}
					errorInfo.text=resourceManager.getString('myResources','LABEL_'+DataModel.getInstance().loginErrorMessage.toLocaleUpperCase());
					DataModel.getInstance().loginErrorMessage="";
				}
			}

			private function set loggedSuccessfully(upd:Boolean):void
			{
				if (DataModel.getInstance().isSuccessfullyLogged == true)
				{
					rememberSO=SharedObject.getLocal("babeliaData");
					if (rememberSO.data.username == undefined || rememberSO.data.hash == undefined)
					{
						//The user wants the application to remember him/her
						if (rememberUser.selected)
						{
							var cacheHash:String=SHA1.hash(password.text);
							rememberSO.data.username=username.text;
							rememberSO.data.hash=cacheHash;
							rememberSO.flush();
						}
						username.text="";
						password.text="";
					}
					DataModel.getInstance().isSuccessfullyLogged=false;
					PopUpManager.removePopUp(DataModel.getInstance().loginPop);
				}
			}

			private function showRestorePass(event:Event):void
			{
				errorInfo.text=DataModel.getInstance().restorePassErrorMessage;
				DataModel.getInstance().restorePassErrorMessage="";
				this.title=resourceManager.getString('myResources', 'TITLE_RESTORE_PASS_FORM');
				username.text = '';
				password.text = '';
				focusManager.setFocus(userOrEmail);
				loginViewStack.selectedChild=restorePassFormBox;
			}
			
			private function showLogin(event:Event):void{
				errorInfo.text = '';
				this.title = resourceManager.getString('myResources', 'TITLE_LOGIN_FORM');
				userOrEmail.text = '';
				focusManager.setFocus(username);
				resendEmailLink.visible = false;
				loginViewStack.selectedChild=loginFormBox;
			}
			
			private function showActivationResend(even:Event):void{
				errorInfo.text='';
				this.title = resourceManager.getString('myResources','LABEL_SEND_EMAIL_AGAIN');
				activationUsername.text = '';
				activationEmail.text = '';
				resendEmailLink.visible = false;
				focusManager.setFocus(activationUsername);
				loginViewStack.selectedChild = resendActivationEmailBox;
			}


			private function set passRecoveryDone(flag:Boolean):void
			{
				PopUpManager.removePopUp(this);
			}

			private function processRestorePass(event:Event):void
			{
				var user:LoginVO=new LoginVO(userOrEmail.text, "");
				new LoginEvent(LoginEvent.RESTORE_PASS, user).dispatch();
			}
			
			private function resendActivationEmail(event:Event):void{
				var data:UserVO=new UserVO();
				data.name = activationUsername.text;
				data.email = activationEmail.text;
				new LoginEvent(LoginEvent.RESEND_ACTIVATION_EMAIL, null, data);
			}
			
			private function set onActivationEmailResent(value:Boolean):void{
				
			}
			
		]]>
	</mx:Script>

	<mx:Binding source="{DataModel.getInstance().loginErrorMessage}"
				destination="wrongLogin"/>
	<mx:Binding source="{DataModel.getInstance().isSuccessfullyLogged}"
				destination="loggedSuccessfully"/>
	<mx:Binding source="{DataModel.getInstance().passRecoveryDone}"
				destination="passRecoveryDone"/>
	<mx:Binding source="{DataModel.getInstance().activationEmailResent}"
				destination="onActivationEmailResent"/>

	<mx:Label id="errorInfo"
			  fontFamily="Arial"
			  fontSize="12"
			  color="#FF0000"
			  fontWeight="bold"
			  textAlign="center"
			  width="100%"/>
	<mx:ViewStack id="loginViewStack"
				  creationPolicy="all"
				  width="100%">
		<mx:VBox id="loginFormBox"
				 width="100%">
			<mx:Form width="100%">
				<mx:FormItem label="{resourceManager.getString('myResources','LABEL_USER_NAME')}">
					<mx:TextInput id="username"
								  width="100%"/>
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString('myResources','LABEL_PASSWORD')}">
					<mx:TextInput id="password"
								  displayAsPassword="true"
								  width="100%"/>
				</mx:FormItem>
			</mx:Form>
			<mx:HBox width="100%"
					 verticalAlign="middle"
					 paddingLeft="12"
					 paddingRight="12">
				<mx:CheckBox label="{resourceManager.getString('myResources','LABEL_REMEMBER_ME')}"
							 id="rememberUser"/>
			</mx:HBox>
			<mx:HBox width="100%"
					 horizontalAlign="center"
					 verticalAlign="middle">
				<mx:Button label="{resourceManager.getString('myResources','BUTTON_OK')}"
						   id="okButton"
						   click="processLogin(event)"/>
				<mx:Button label="{resourceManager.getString('myResources','BUTTON_CANCEL')}"
						   id="cancelButton"
						   click="cancelButtonClickHandler(event)"/>
			</mx:HBox>
			<mx:VBox id="loginProblemTroubleshootingBox"
					 width="100%"
					 horizontalAlign="center"
					 paddingTop="10">
				<mx:LinkButton label="{resourceManager.getString('myResources','LABEL_I_FORGOT_MY_PASSWORD')}"
							   id="restorePassword"
							   textDecoration="underline"
							   click="showRestorePass(event)"/>
				<mx:LinkButton label="{resourceManager.getString('myResources','LABEL_SEND_EMAIL_AGAIN')}"
							   id="resendEmailLink"
							   textDecoration="underline"
							   click="showActivationResend(event)"
							   visible="false"/>
			</mx:VBox>
		</mx:VBox>

		<mx:VBox id="restorePassFormBox"
				 width="100%">

			<mx:Label text="{resourceManager.getString('myResources','LABEL_USER_OR_EMAIL')}"/>
			<mx:TextInput id="userOrEmail"
						  width="100%"/>
			<mx:Spacer width="20"/>
			<mx:HBox width="100%"
					 horizontalAlign="center"
					 verticalAlign="middle">
				<mx:Button label="{resourceManager.getString('myResources','LABEL_RESTORE_PASSWORD')}"
						   id="restoreButton"
						   click="processRestorePass(event)"/>
				<mx:Button label="{resourceManager.getString('myResources','BUTTON_CANCEL')}"
						   id="cancelRestoreButton"
						   click="showLogin(event)"/>
			</mx:HBox>
		</mx:VBox>
		
		<mx:VBox id="resendActivationEmailBox" width="100%">
			<mx:Label text="{resourceManager.getString('myResources','LABEL_INPUT_USER_AND_EMAIL')}"/>
			<mx:Form width="100%">
				<mx:FormItem label="{resourceManager.getString('myResources','LABEL_USER_NAME')}">
					<mx:TextInput id="activationUsername"
								  width="100%"/>
				</mx:FormItem>
				<mx:FormItem label="{resourceManager.getString('myResources','LABEL_EMAIL')}">
					<mx:TextInput id="activationEmail"
								  width="100%"/>
				</mx:FormItem>
			</mx:Form>
			<mx:HBox width="100%"
					 horizontalAlign="center"
					 verticalAlign="middle">
				<mx:Button label="{resourceManager.getString('myResources','BUTTON_OK')}"
						   id="activationOkButton"
						   click="resendActivationEmail(event)"/>
				<mx:Button label="{resourceManager.getString('myResources','BUTTON_CANCEL')}"
						   id="activationCancelButton"
						   click="cancelButtonClickHandler(event)"/>
			</mx:HBox>
		</mx:VBox>
		
	</mx:ViewStack>
</common:CustomTitleWindow>
