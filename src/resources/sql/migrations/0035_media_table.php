<?php

function forwards(){
	global $DB, $VP, $CFG;
	try {
		$DB->_startTransaction();
		
		$sql_create = "CREATE TABLE `media` (
						`id` int(10) unsigned NOT NULL AUTO_INCREMENT,
						`mediacode` varchar(45) NOT NULL,
						`instanceid` int(10) unsigned NOT NULL,
						`component` varchar(45) NOT NULL,
						`filename` varchar(255) NOT NULL,
						`contenthash` varchar(40) NOT NULL,
						`status` tinyint(10) NOT NULL DEFAULT '0',
						`timecreated` int(11) NOT NULL DEFAULT '0',
						`timemodified` int(11) NOT NULL DEFAULT '0',
						`license` varchar(60) NOT NULL DEFAULT 'cc-by',
						`authorref` text,
						`duration` int(10) unsigned NOT NULL DEFAULT '0',
						`filesize` int(11) NOT NULL DEFAULT '0',
						`metadata` text,
						`level` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0: undefined, 1: primary, 2: model, 3: attempt, 4: raw',
						`fk_user_id` int(10) unsigned NOT NULL,
						PRIMARY KEY (`id`),
						UNIQUE KEY `code_UNIQUE` (`mediacode`),
						KEY `fk_media_1` (`fk_user_id`),
						CONSTRAINT `fk_media_1` FOREIGN KEY (`fk_user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
					   ) ENGINE=InnoDB DEFAULT CHARSET=utf8;";
		$DB->_update($sql_create);
		
		$sql = "SELECT name AS code, id AS instanceid, filehash AS contenthash,
					   status, UNIX_TIMESTAMP(adding_date) AS timecreated, license, reference AS authorref, duration, fk_user_id
				FROM exercise WHERE id>0";
		
		$results = $DB->_multipleSelect($sql);
		$medias = array();
		foreach ($results as $r){
			$m = new stdClass();
			$m->code = strpos($r->code, '.') === FALSE ? $r->code : uuidv4();
			$m->instanceid = $r->instanceid;
			$m->component = 'exercise';
			$m->filename = strpos($r->code, '.') === FALSE ? $r->code . '.flv' : $r->code;
			$m->contenthash = $r->contenthash != 'none' ? $r->contenthash : null;
			$m->status = get_status_code($r->status);
			$m->timecreated = $r->timecreated;
			$m->timemodified = $m->timecreated;
			$m->license = $r->license;
			$m->authorref = $r->authorref;
			$m->duration = $r->duration;
			$m->fk_user_id = $r->fk_user_id;
			if(is_file($CFG->red5Path . '/exercises/' . $m->filename)){
				$data = custom_json_encode($VP->retrieveMediaInfo($CFG->red5Path . '/exercises/' . $m->filename));
				$m->filesize = filesize($CFG->red5Path . '/exercises/' . $m->filename);
				$m->metadata = $data;
			} else {
				$m->filesize = 0;
				$m->metadata = null;
			}
			$medias[] = $m;
			insertmedia($m);
		}
		
		$DB->_endTransaction();
		
	} catch (Exception $e) {
		$DB->_failedTransaction();
		throw $e;
	}
}

function backwards(){
	global $DB;

	$sql_drop = "DROP TABLE IF EXISTS `media`";

}

define('STATUS_UNPROCESSED', 0);
define('STATUS_PROCESSING', 1);
define('STATUS_AVAILABLE', 2);
define('STATUS_REJECTED', 3);
define('STATUS_ERROR', 4);
define('STATUS_UNAVAILABLE', 5);
define('STATUS_UNPRONOPRAC', 6);
define('STATUS_UNSLICED', 7);

function get_status_code($status){
	$code = 0;
	switch($status){
		case 'Unprocessed':
			$code = STATUS_UNPROCESSED;
			break;
		case 'Processing':
			$code = STATUS_PROCESSING;
			break;
		case 'Available':
			$code = STATUS_AVAILABLE;
			break;
		case 'Rejected':
			$code = STATUS_REJECTED;
			break;
		case 'Error':
			$code = STATUS_ERROR;
			break;
		case 'Unavailable':
			$code = STATUS_UNAVAILABLE;
			break;
		case 'UnprocessedNoPractice':
			$code = STATUS_UNPRONOPRAC;
			break;
		case 'Unsliced':
			$code = STATUS_UNSLICED;
			break;
	}
	return $code;
}

function insertmedia($m){
	global $DB;
	$sql = "INSERT INTO media (mediacode,instanceid,component,filename,contenthash,status,timecreated,timemodified,license,authorref,duration,fk_user_id,metadata,filesize,level) VALUES ('%s', %d, '%s', '%s', '%s', %d, %d, %d, '%s', '%s', %d, %d,'%s',%d,%d)";
	$DB->_insert($sql,$m->code,$m->instanceid,$m->component,$m->filename,$m->contenthash,$m->status,$m->timecreated,$m->timemodified,$m->license,$m->authorref,$m->duration,$m->fk_user_id,$m->metadata,$m->filesize,1);
}

/**
 * Helper function to generate RFC4122 compliant UUIDs
 *
 * @return String $uuid
 * 		A RFC4122 compliant string
 */
function uuidv4()
{
	//When the openssl extension is not available in *nix systems try using urandom
	if(function_exists('openssl_random_pseudo_bytes')){
		$data = openssl_random_pseudo_bytes(16);
	} else {
		$data = file_get_contents('/dev/urandom', NULL, NULL, 0, 16);
	}

	$data[6] = chr(ord($data[6]) & 0x0f | 0x40); // set version to 0100
	$data[8] = chr(ord($data[8]) & 0x3f | 0x80); // set bits 6-7 to 10

	return vsprintf('%s%s-%s-%s-%s-%s%s%s', str_split(bin2hex($data), 4));
}

$models = '{"assignment":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_course_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"course","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"name":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":null,"extra":""},"description":{"type":{"name":"longtext"},"empty":"NO","key":"","default":null,"extra":""},"duedate":{"type":{"name":"bigint","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"allowsubmissionsfromdate":{"type":{"name":"bigint","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"grade":{"type":{"name":"varchar","size":"45"},"empty":"YES","key":"","default":null,"extra":""},"timemodified":{"type":{"name":"bigint","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"teamsubmission":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"0","extra":""},"requireallteammemberssubmit":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"0","extra":""},"maxattempts":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_course_id"}]},"assignment_submission":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_assignment_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"assignment","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"timecreated":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"timemodified":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"status":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":"","extra":""},"fk_group_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"course_groups","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"attempnumber":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_assignment_id"},{"type":"index","columns":"fk_user_id"},{"type":"index","columns":"fk_group_id"}]},"course":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"category":{"type":{"name":"int","size":"11"},"empty":"NO","key":"","default":"0","extra":""},"fullname":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":"","extra":""},"fk_serviceconsumer_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"serviceconsumer","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"idnumber":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"shortname":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":"","extra":""},"summary":{"type":{"name":"longtext"},"empty":"YES","key":"","default":null,"extra":""},"format":{"type":{"name":"varchar","size":"21"},"empty":"NO","key":"","default":"topics","extra":""},"startdate":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"visible":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"1","extra":""},"language":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":"","extra":""},"timecreated":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"timemodified":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_serviceconsumer_id"}]},"course_groups":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_course_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"course","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"name":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":"","extra":""},"description":{"type":{"name":"longtext"},"empty":"YES","key":"","default":null,"extra":""},"timecreated":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"timemodified":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_course_id"}]},"credithistory":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"ID","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_response_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"response","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_eval_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"","default":null,"extra":""},"changeDate":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"changeType":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"changeAmount":{"type":{"name":"int","size":"11"},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_user_id"},{"type":"index","columns":"fk_response_id"},{"type":"index","columns":"fk_exercise_id"}]},"evaluation":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_response_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"response","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"score_overall":{"type":{"name":"tinyint","size":"4"},"empty":"YES","key":"","default":"0","extra":""},"comment":{"type":{"name":"text"},"empty":"YES","key":"","default":null,"extra":""},"adding_date":{"type":{"name":"timestamp"},"empty":"YES","key":"","default":"CURRENT_TIMESTAMP","extra":""},"score_intonation":{"type":{"name":"tinyint","size":"3","unsigned":true},"empty":"YES","key":"","default":"0","extra":""},"score_fluency":{"type":{"name":"tinyint","size":"3","unsigned":true},"empty":"YES","key":"","default":"0","extra":""},"score_rhythm":{"type":{"name":"tinyint","size":"3","unsigned":true},"empty":"YES","key":"","default":"0","extra":""},"score_spontaneity":{"type":{"name":"tinyint","size":"3","unsigned":true},"empty":"YES","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_response_id"},{"type":"index","columns":"fk_user_id"}]},"evaluation_video":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_evaluation_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"evaluation","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"video_identifier":{"type":{"name":"varchar","size":"100"},"empty":"NO","key":"","default":null,"extra":""},"source":{"type":{"name":"enum"},"empty":"NO","key":"","default":null,"extra":""},"thumbnail_uri":{"type":{"name":"varchar","size":"200"},"empty":"NO","key":"","default":"nothumb.png","extra":""},"duration":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_evaluation_id"}]},"exercise":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"name":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":null,"extra":""},"description":{"type":{"name":"text"},"empty":"NO","key":"","default":null,"extra":""},"source":{"type":{"name":"enum"},"empty":"NO","key":"","default":null,"extra":""},"language":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"tags":{"type":{"name":"varchar","size":"100"},"empty":"NO","key":"","default":null,"extra":""},"title":{"type":{"name":"varchar","size":"80"},"empty":"NO","key":"","default":null,"extra":""},"thumbnail_uri":{"type":{"name":"varchar","size":"200"},"empty":"NO","key":"","default":"nothumb.png","extra":""},"adding_date":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"duration":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":null,"extra":""},"status":{"type":{"name":"enum"},"empty":"NO","key":"","default":"Unprocessed","extra":""},"filehash":{"type":{"name":"varchar","size":"32"},"empty":"NO","key":"","default":"none","extra":""},"fk_transcription_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"transcription","referenced_column":"id","update_rule":"RESTRICT","delete_rule":"SET NULL"}},"license":{"type":{"name":"varchar","size":"60"},"empty":"NO","key":"","default":"cc-by","extra":""},"reference":{"type":{"name":"text"},"empty":"NO","key":"","default":null,"extra":""},"type":{"type":{"name":"int","size":"11"},"empty":"NO","key":"","default":"5","extra":""},"situation":{"type":{"name":"int","size":"11"},"empty":"YES","key":"","default":null,"extra":""},"competence":{"type":{"name":"int","size":"11"},"empty":"YES","key":"","default":null,"extra":""},"lingaspects":{"type":{"name":"varchar","size":"45"},"empty":"YES","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_user_id"},{"type":"index","columns":"fk_transcription_id"}]},"exercise_comment":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"ID","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"comment":{"type":{"name":"text"},"empty":"NO","key":"","default":null,"extra":""},"comment_date":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_user_id"}]},"exercise_descriptor":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"situation":{"type":{"name":"tinyint","size":"2","unsigned":true},"empty":"NO","key":"MUL","default":"1","extra":""},"level":{"type":{"name":"tinyint","size":"3","unsigned":true},"empty":"NO","key":"","default":"1","extra":""},"competence":{"type":{"name":"tinyint","size":"3","unsigned":true},"empty":"NO","key":"","default":"1","extra":""},"number":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":"1","extra":""},"alte":{"type":{"name":"tinyint","size":"1","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"situation,level,competence,number"}]},"exercise_descriptor_i18n":{"fk_exercise_descriptor_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"","constraint":{"referenced_table":"exercise_descriptor","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"locale":{"type":{"name":"varchar","size":"8"},"empty":"NO","key":"PRI","default":null,"extra":""},"name":{"type":{"name":"text"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"fk_exercise_descriptor_id,locale"},{"type":"index","columns":"fk_exercise_descriptor_id"}]},"exercise_level":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"suggested_level":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":null,"extra":""},"suggest_date":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_user_id"}]},"exercise_report":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"ID","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"reason":{"type":{"name":"varchar","size":"100"},"empty":"NO","key":"","default":null,"extra":""},"report_date":{"type":{"name":"timestamp"},"empty":"NO","key":"","default":"CURRENT_TIMESTAMP","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_user_id"}]},"exercise_role":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"character_name":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_user_id"}]},"exercise_score":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"suggested_score":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":null,"extra":""},"suggestion_date":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_user_id"}]},"moodle_api":{"access_key":{"type":{"name":"varchar","size":"20"},"empty":"NO","key":"PRI","default":null,"extra":""},"secret_access_key":{"type":{"name":"varchar","size":"40"},"empty":"NO","key":"","default":null,"extra":""},"allowed_referer":{"type":{"name":"varchar","size":"100"},"empty":"NO","key":"","default":null,"extra":""},"raw_referer":{"type":{"name":"varchar","size":"100"},"empty":"NO","key":"","default":"","extra":""},"fk_user_id":{"type":{"name":"int","size":"11","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"date_created":{"type":{"name":"timestamp"},"empty":"NO","key":"","default":"CURRENT_TIMESTAMP","extra":""},"Meta":[{"type":"primary","columns":"access_key"},{"type":"index","columns":"fk_user_id"}]},"motd":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"title":{"type":{"name":"varchar","size":"250"},"empty":"NO","key":"","default":null,"extra":""},"message":{"type":{"name":"text"},"empty":"NO","key":"","default":null,"extra":""},"resource":{"type":{"name":"varchar","size":"250"},"empty":"NO","key":"","default":null,"extra":""},"displaydate":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"displaywhenloggedin":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"0","extra":""},"code":{"type":{"name":"varchar","size":"45"},"empty":"YES","key":"","default":null,"extra":""},"language":{"type":{"name":"varchar","size":"5"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"}]},"preferences":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"prefName":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"UNI","default":null,"extra":""},"prefValue":{"type":{"name":"varchar","size":"200"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"prefName"}]},"rel_course_role_user":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_role_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"role","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_course_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"course","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"timemodified":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_course_id"},{"type":"index","columns":"fk_role_id"},{"type":"index","columns":"fk_user_id"}]},"rel_coursegroup_user":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":""},"fk_group_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"course_groups","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"timeadded":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_group_id"},{"type":"index","columns":"fk_user_id"}]},"rel_exercise_descriptor":{"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_exercise_descriptor_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"","constraint":{"referenced_table":"exercise_descriptor","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"Meta":[{"type":"primary","columns":"fk_exercise_id,fk_exercise_descriptor_id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_exercise_descriptor_id"}]},"rel_exercise_tag":{"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_tag_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"","constraint":{"referenced_table":"tag","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"Meta":[{"type":"primary","columns":"fk_exercise_id,fk_tag_id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_tag_id"}]},"response":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":""},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"file_identifier":{"type":{"name":"varchar","size":"100"},"empty":"NO","key":"UNI","default":null,"extra":""},"is_private":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":null,"extra":""},"thumbnail_uri":{"type":{"name":"varchar","size":"200"},"empty":"NO","key":"","default":"nothumb.png","extra":""},"source":{"type":{"name":"enum"},"empty":"NO","key":"","default":null,"extra":""},"duration":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":null,"extra":""},"adding_date":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"rating_amount":{"type":{"name":"int","size":"10"},"empty":"NO","key":"","default":null,"extra":""},"character_name":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"fk_transcription_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"transcription","referenced_column":"id","update_rule":"RESTRICT","delete_rule":"SET NULL"}},"fk_subtitle_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"subtitle","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"priority_date":{"type":{"name":"timestamp"},"empty":"NO","key":"","default":"CURRENT_TIMESTAMP","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"file_identifier"},{"type":"index","columns":"fk_user_id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_transcription_id"},{"type":"index","columns":"fk_subtitle_id"}]},"role":{"id":{"type":{"name":"int","size":"11","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"name":{"type":{"name":"varchar","size":"255"},"empty":"YES","key":"","default":"","extra":""},"shortname":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":null,"extra":""},"description":{"type":{"name":"varchar","size":"45"},"empty":"YES","key":"","default":"","extra":""},"sortorder":{"type":{"name":"int","size":"11"},"empty":"NO","key":"","default":null,"extra":""},"archetype":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":"","extra":""},"Meta":[{"type":"primary","columns":"id"}]},"serviceconsumer":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"access_key":{"type":{"name":"varchar","size":"20"},"empty":"NO","key":"UNI","default":null,"extra":""},"secret_access_key":{"type":{"name":"varchar","size":"40"},"empty":"NO","key":"","default":null,"extra":""},"name":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":null,"extra":""},"domain":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":null,"extra":""},"ipaddress":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":"","extra":""},"timecreated":{"type":{"name":"bigint","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"timemodified":{"type":{"name":"bigint","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"requestlimit":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":"100","extra":""},"enabled":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"1","extra":""},"salt":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"access_key"}]},"serviceconsumer_log":{"id":{"type":{"name":"int","size":"11"},"empty":"NO","key":"PRI","default":null,"extra":""},"fk_serviceconsumer_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"serviceconsumer","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"time":{"type":{"name":"bigint","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"method":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":"","extra":""},"statuscode":{"type":{"name":"int","size":"11"},"empty":"NO","key":"","default":"500","extra":""},"ip":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":"","extra":""},"referer":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":"","extra":""},"origin":{"type":{"name":"varchar","size":"255"},"empty":"NO","key":"","default":"","extra":""},"consumertime":{"type":{"name":"bigint","size":"10"},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_serviceconsumer_id"}]},"spinvox_request":{"id":{"type":{"name":"int","size":"11","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"x_error":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"url":{"type":{"name":"varchar","size":"200"},"empty":"YES","key":"","default":null,"extra":""},"date":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"fk_transcription_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"transcription","referenced_column":"id","update_rule":"NO ACTION","delete_rule":"NO ACTION"}},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_transcription_id"}]},"subtitle":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"ID","update_rule":"SET NULL","delete_rule":"SET NULL"}},"language":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"translation":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"0","extra":""},"adding_date":{"type":{"name":"timestamp"},"empty":"NO","key":"","default":"CURRENT_TIMESTAMP","extra":"on update CURRENT_TIMESTAMP"},"complete":{"type":{"name":"tinyint","size":"1","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"serialized_subtitles":{"type":{"name":"longtext"},"empty":"NO","key":"","default":null,"extra":""},"subtitle_count":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_user_id"}]},"tag":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"name":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"}]},"transcription":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"adding_date":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"status":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"transcription":{"type":{"name":"text"},"empty":"YES","key":"","default":null,"extra":""},"transcription_date":{"type":{"name":"datetime"},"empty":"YES","key":"","default":null,"extra":""},"system":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"Meta":[{"type":"primary","columns":"id"}]},"user":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"username":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"MUL","default":null,"extra":""},"fk_serviceconsumer_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"","default":null,"extra":""},"password":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"email":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"firstname":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"lastname":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"creditCount":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":"0","extra":""},"joiningDate":{"type":{"name":"timestamp"},"empty":"NO","key":"","default":"CURRENT_TIMESTAMP","extra":""},"active":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"0","extra":""},"activation_hash":{"type":{"name":"varchar","size":"20"},"empty":"NO","key":"","default":null,"extra":""},"isAdmin":{"type":{"name":"tinyint","size":"4"},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"username,fk_serviceconsumer_id"}]},"user_languages":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"language":{"type":{"name":"varchar","size":"45"},"empty":"NO","key":"","default":null,"extra":""},"level":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":null,"extra":""},"positives_to_next_level":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"","default":null,"extra":""},"purpose":{"type":{"name":"enum"},"empty":"NO","key":"","default":"practice","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_user_id"}]},"user_session":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"session_id":{"type":{"name":"varchar","size":"100"},"empty":"NO","key":"","default":null,"extra":""},"session_date":{"type":{"name":"datetime"},"empty":"NO","key":"","default":null,"extra":""},"duration":{"type":{"name":"int","size":"10"},"empty":"NO","key":"","default":null,"extra":""},"keep_alive":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":null,"extra":""},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"closed":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"0","extra":""},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_user_id"}]},"user_videohistory":{"id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"PRI","default":null,"extra":"auto_increment"},"fk_user_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_user_session_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"user_session","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_exercise_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"NO","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"response_attempt":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"0","extra":""},"fk_response_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"response","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"incidence_date":{"type":{"name":"timestamp"},"empty":"NO","key":"","default":"CURRENT_TIMESTAMP","extra":""},"subtitles_are_used":{"type":{"name":"tinyint","size":"1"},"empty":"NO","key":"","default":"0","extra":""},"fk_subtitle_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"subtitle","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"fk_exercise_role_id":{"type":{"name":"int","size":"10","unsigned":true},"empty":"YES","key":"MUL","default":null,"extra":"","constraint":{"referenced_table":"exercise_role","referenced_column":"id","update_rule":"CASCADE","delete_rule":"CASCADE"}},"Meta":[{"type":"primary","columns":"id"},{"type":"index","columns":"fk_user_id"},{"type":"index","columns":"fk_user_session_id"},{"type":"index","columns":"fk_exercise_id"},{"type":"index","columns":"fk_response_id"},{"type":"index","columns":"fk_subtitle_id"},{"type":"index","columns":"fk_exercise_role_id"}]}}';

