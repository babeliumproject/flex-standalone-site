<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009"
		 xmlns:s="library://ns.adobe.com/flex/spark"
		 xmlns:mx="library://ns.adobe.com/flex/mx"
		 xmlns:main="components.main.*"
		 xmlns:skins="skins.*"
		 width="100%"
		 creationComplete="completeHandler(event)">

	<s:VGroup width="100%"
			  minWidth="1000"
			  height="100%"
			  gap="0">

		<s:BorderContainer id="headerBorderContainer"
						   styleName="headerBorderContainer"
						   minHeight="0"
						   width="100%"
						   minWidth="1000">

			<s:layout>
				<s:HorizontalLayout paddingTop="4"
									paddingBottom="8"
									paddingLeft="20"
									paddingRight="20"
									verticalAlign="middle"/>
			</s:layout>

			<mx:Image source="resources/images/babelium_logo.png"
					  buttonMode="true"
					  click="{URLManager.getInstance().redirect('/home')}"/>

			<s:HGroup horizontalAlign="right"
					  verticalAlign="middle"
					  width="100%"/>
			
			<s:Label text="{resourceManager.getString('myResources','LANGUAGE')}"/>
			<main:LocalizationComboBox id="localeComboBox"/>
			
			<!-- Show this box when user is not identified -->
			<s:HGroup id="anonymousCP"
					  horizontalAlign="right"
					  verticalAlign="middle"
					  visible="true"
					  includeInLayout="true"
					  height="100%">
				<skins:IconButton id="signInButton"
								  styleName="yellowLinkButton"
								  label="{resourceManager.getString('myResources', 'SIGN_IN')}"
								  click="signInClickHandler()"
								  visible="{_urlManager.moduleName != 'login'}"
								  includeInLayout="{_urlManager.moduleName != 'login'}"/>
				<skins:IconButton id="signUpButton"
								  styleName="yellowLinkButton"
								  label="{resourceManager.getString('myResources', 'REGISTER')}"
								  click="signUpClickHandler()"/>
			</s:HGroup>
			<s:HGroup id="userCP"
					  horizontalAlign="right"
					  verticalAlign="middle"
					  visible="false"
					  includeInLayout="false"
					  height="100%">
				<!--
				<mx:VRule height="20"
						  styleName="sectionTitleHRule"/>
				-->
				<s:HGroup verticalAlign="middle"
						  horizontalAlign="center">
					<s:BitmapImage source="@Embed('/resources/images/coins_icon.png')"/>
					<s:Label id="uCrds"
							 text="cr."
							 styleName="creditLinkButton"
							 verticalAlign="justify" 
							 toolTip="{resourceManager.getString('myResources','CREDIT_COUNT')}"/>
				</s:HGroup>
				<mx:VRule height="20"
						  styleName="sectionTitleHRule"/>

				<s:Graphic height="32" width="32">
					<s:Path data="M 41.64446,36.192409 C 34.76647,34.603259 28.36416,33.211689 31.46483,27.355979 40.9029,9.531989 33.96654,-1.049066e-6 24.00012,-1.049066e-6 13.83727,-1.049066e-6 7.0715895,9.897849 16.53541,27.355979 c 3.19363,5.89142 -3.44948,7.28148 -10.1796305,8.83643 -6.87519,1.58822 -6.34638,5.21933 -6.34638,11.80759 H 47.9906 c 0,-6.58837 0.52882,-10.21937 -6.34614,-11.80759 z">
						<s:stroke>
							<s:SolidColorStroke weight="2" color="0xcccccc"/> 
						</s:stroke>
						<s:fill>
							<s:SolidColor color="0xffffff"/>
						</s:fill>
					</s:Path>
				</s:Graphic>
				<s:HGroup gap="0"
						  verticalAlign="middle"
						  height="100%">
					<s:Label text="("
							 styleName="boldDarkerGreyLabel"/>
					<skins:IconButton id="userCPName"
									  styleName="orangeLinkButton"
									  label="UserName"
									  click="userOptionsItemClickHandler(event)"/>
					<s:Label text=")"
							 styleName="boldDarkerGreyLabel"/>
				</s:HGroup>
				<skins:IconButton id="signOutButton"
								  styleName="signOutLinkButton"
								  toolTip="{resourceManager.getString('myResources','SIGN_OUT')}"
								  click="signOutClickHandler()"/>
			</s:HGroup>

		</s:BorderContainer>

	</s:VGroup>

	<fx:Script>
		<![CDATA[
			import control.URLManager;
			
			import events.LoginEvent;
			
			import flash.net.navigateToURL;
			
			import model.DataModel;
			
			import mx.binding.utils.BindingUtils;
			import mx.core.FlexGlobals;
			import mx.core.IFlexDisplayObject;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			
			import spark.effects.Animate;
			import spark.effects.animation.MotionPath;
			import spark.effects.animation.RepeatBehavior;
			import spark.effects.animation.SimpleMotionPath;
			
			[Bindable] protected var _urlManager:URLManager=URLManager.getInstance();
			
			private var popup:LoginPopup;

			public function completeHandler(event:FlexEvent):void
			{
				var model:DataModel=DataModel.getInstance();

				BindingUtils.bindSetter(onUserAuthenticated, model, "isLoggedIn");
				BindingUtils.bindSetter(creditsUpdated, model, "creditUpdateRetrieved");
				BindingUtils.bindSetter(exerciseRecording, model, "recordingExercise");
				BindingUtils.bindSetter(onAccountActivation, model, "accountActivationRetrieved");
			}

			public function signInClickHandler():void
			{
				//Create and show login popup
				createLoginPopUp();
			}

			public function createLoginPopUp():void
			{
				var parent:DisplayObject=FlexGlobals.topLevelApplication.parent;
				var modal:Boolean=true;
				
				popup=PopUpManager.createPopUp(parent,LoginPopup,modal) as LoginPopup;
				popup.addEventListener(CloseEvent.CLOSE,destroyLoginPopUp,false,0,true);
				
				PopUpManager.centerPopUp(popup);
			}
			
			public function destroyLoginPopUp(event:CloseEvent):void{
				PopUpManager.removePopUp(popup);
				popup=null;
			}

			public function signUpClickHandler():void
			{
				//Change contentViewStack to sign up page
				//new ViewChangeEvent(ViewChangeEvent.VIEW_REGISTER_MODULE).dispatch();
				URLManager.getInstance().redirect('signup');
			}

			public function userOptionsItemClickHandler(event:MouseEvent):void
			{
				//new ViewChangeEvent(ViewChangeEvent.VIEW_ACCOUNT_MODULE).dispatch();
				URLManager.getInstance().redirect('account');
			}

			public function signOutClickHandler():void
			{
				//Since our user isn't signed in we hide the users cp
				new LoginEvent(LoginEvent.SIGN_OUT, null).dispatch();
				// Redirecting to home
				//new ViewChangeEvent(ViewChangeEvent.VIEW_HOME_MODULE).dispatch();
				URLManager.getInstance().redirect('home');
				anonymousCP.includeInLayout=true;
				anonymousCP.visible=true;
				userCP.includeInLayout=false;
				userCP.visible=false;
			}

			private function onUserAuthenticated(upd:Boolean):void
			{
				if (DataModel.getInstance().isLoggedIn)
				{
					anonymousCP.visible=false;
					anonymousCP.includeInLayout=false;
					userCPName.label=DataModel.getInstance().loggedUser.username;
					uCrds.text=DataModel.getInstance().loggedUser.creditCount.toString();
					userCP.includeInLayout=true;
					userCP.visible=true;
					callLater(localeComboBox.updateSelectedIndex);

				}
			}

			private function blinkCredits():void
			{
				var motion:SimpleMotionPath=new SimpleMotionPath();
				motion.property="alpha";
				motion.valueFrom=1.0;
				motion.valueTo=0.0;
				var motionVector:Vector.<MotionPath>=new Vector.<MotionPath>();
				motionVector.push(motion);

				var anim:Animate=new Animate();
				anim.repeatBehavior=RepeatBehavior.REVERSE;
				anim.repeatCount=20;
				anim.duration=300;
				anim.target=uCrds;
				anim.motionPaths=motionVector;
				anim.play();
			}

			private function creditsUpdated(retr:Boolean):void
			{
				if (DataModel.getInstance().loggedUser && DataModel.getInstance().creditUpdateRetrieved)
				{
					uCrds.text=DataModel.getInstance().loggedUser.creditCount.toString();
					blinkCredits();
					DataModel.getInstance().creditUpdateRetrieved=false;
				}
			}

			private function exerciseRecording(value:Boolean):void
			{
				var status:Boolean=!DataModel.getInstance().recordingExercise;
				signInButton.enabled=status;
				signUpButton.enabled=status;
				signOutButton.enabled=status;
			}

			private function onAccountActivation(flag:Boolean):void
			{
				if (flag == true)
					localeComboBox.updateSelectedIndex();
			}
		]]>
	</fx:Script>

</s:Group>
